import os
import re
import pdfplumber
from fastapi import FastAPI, Header, HTTPException, UploadFile, File
from playwright.async_api import async_playwright

app = FastAPI(title="JurisExtract API")

# REPLACE THIS: Your secret from the RapidAPI Provider Dashboard -> Security tab
RAPID_SECRET = os.getenv("RAPID_PROXY_SECRET", "your_secret_here")

# --- PARSER LOGIC ---
class LegalParser:
    def __init__(self):
        # Pattern for US Case Citations (e.g., 410 U.S. 113)
        self.cite_pattern = re.compile(r'(\d+\s+U\.S\.\s+\d+)|(\d+\s+F\.\d?d\s+\d+)')

    def extract_authorities(self, pdf_bytes):
        results = []
        with pdfplumber.open(pdf_bytes) as pdf:
            for page in pdf.pages:
                text = page.extract_text()
                if text and "TABLE OF AUTHORITIES" in text.upper():
                    # Extract citations from the TOA section
                    matches = self.cite_pattern.findall(text)
                    results.extend([m[0] or m[1] for m in matches])
        return list(set(results)) # Return unique citations

parser = LegalParser()

# --- SECURITY MIDDLEWARE ---
@app.middleware("http")
async def verify_rapidapi_proxy(request, call_next):
    # RapidAPI injects this header to prove the request came through their gateway
    proxy_secret = request.headers.get("X-RapidAPI-Proxy-Secret")
    if proxy_secret != RAPID_SECRET:
        return HTTPException(status_code=403, detail="Direct access forbidden")
    return await call_next(request)

# --- API ENDPOINTS ---

@app.post("/extract-precedent")
async def extract_precedent(file: UploadFile = File(...)):
    """Upload a PDF filing to extract all legal authorities."""
    contents = await file.read()
    from io import BytesIO
    authorities = parser.extract_authorities(BytesIO(contents))
    return {"status": "success", "count": len(authorities), "data": authorities}

@app.get("/scrape-docket/{court}/{docket_id}")
async def get_docket(court: str, docket_id: str):
    """Automates a browser to fetch docket metadata (Conceptual)."""
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        page = await browser.new_page()
        # Note: Replace with actual target court URL
        await page.goto(f"https://{court}.uscourts.gov/search?q={docket_id}")
        title = await page.title()
        await browser.close()
        return {"court": court, "docket": docket_id, "case_title": title}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
